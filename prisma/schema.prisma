generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================================
// LAYER 1: RAW OTA INGESTION (Write-Only)
// ==========================================================

model OtaPayload {
  id               Int      @id @default(autoincrement())
  otaName          String   @map("ota_name")
  endpoint         String
  requestSignature String   @map("request_signature")
  response         String   @map("response") // JSONB in Postgres, mapped to String for SQLite
  fetchedAt        DateTime @map("fetched_at")

  @@map("ota_payloads")
}

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  mobile          String?   @unique
  password        String?   // Made optional for OAuth users
  name            String?
  profilePicture  String?   @map("profile_picture")
  address         String?
  city            String?
  country         String?
  dateOfBirth     DateTime? @map("date_of_birth")
  preferences     String?   // JSON string for user preferences
  googleId        String?   @unique @map("google_id")
  isEmailVerified Boolean   @default(false) @map("is_email_verified")
  isMobileVerified Boolean  @default(false) @map("is_mobile_verified")
  lastLoginAt     DateTime? @map("last_login_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("users")
}

// ==========================================================
// LAYER 2: CANONICAL NORMALIZED TABLES (UI Source of Truth)
// ==========================================================

model Hotel {
  id              String   @id @default(uuid())
  canonicalName   String   @map("canonical_name")
  normalizedName  String   @map("normalized_name")
  slug            String   @unique
  address         String?
  city            String
  country         String
  latitude        Decimal?
  longitude       Decimal?
  starRating      Int?     @map("star_rating") // CHECK (star_rating BETWEEN 1 AND 5) handled in logic
  propertyType    String?  @map("property_type")
  description     String?
  primaryImageUrl String?  @map("primary_image_url")
  reviewScore     Decimal? @map("review_score")
  reviewCount     Int?     @map("review_count")
  qualityScore    Int?     @map("quality_score")
  createdAt       DateTime @default(now()) @map("created_at")

  otaHotels OtaHotel[]
  images    HotelImage[]
  amenities HotelAmenity[]
  roomTypes RoomType[]

  @@index([city])
  @@index([slug])
  @@map("hotels")
}

model OtaHotel {
  id              Int      @id @default(autoincrement())
  hotelId         String   @map("hotel_id")
  hotel           Hotel    @relation(fields: [hotelId], references: [id])
  otaName         String   @map("ota_name")
  otaHotelId      String   @map("ota_hotel_id")
  matchConfidence Decimal? @map("match_confidence")

  @@map("ota_hotels")
}

model HotelImage {
  id           Int     @id @default(autoincrement())
  hotelId      String  @map("hotel_id")
  hotel        Hotel   @relation(fields: [hotelId], references: [id])
  imageUrl     String  @map("image_url")
  sourceOta    String? @map("source_ota")
  isPrimary    Boolean @default(false) @map("is_primary")
  displayOrder Int?    @map("display_order")

  @@map("hotel_images")
}

model AmenityMaster {
  id      Int            @id // SmallInt maps to Int in Prisma
  name    String
  iconKey String?        @map("icon_key")
  hotels  HotelAmenity[]

  @@map("amenities_master")
}

model HotelAmenity {
  hotelId   String        @map("hotel_id")
  hotel     Hotel         @relation(fields: [hotelId], references: [id])
  amenityId Int           @map("amenity_id")
  amenity   AmenityMaster @relation(fields: [amenityId], references: [id])

  @@id([hotelId, amenityId])
  @@map("hotel_amenities")
}

model RoomType {
  id               String   @id @default(uuid())
  hotelId          String   @map("hotel_id")
  hotel            Hotel    @relation(fields: [hotelId], references: [id])
  canonicalName    String   @map("canonical_name")
  roomClass        String?  @map("room_class")
  maxGuests        Int?     @map("max_guests")
  bedConfiguration String?  @map("bed_configuration")
  roomSizeSqft     Int?     @map("room_size_sqft")
  rates            RoomRate[]
  aliases          OtaRoomAlias[]

  @@index([hotelId])
  @@map("room_types")
}

model OtaRoomAlias {
  id              Int      @id @default(autoincrement())
  roomTypeId      String   @map("room_type_id")
  roomType        RoomType @relation(fields: [roomTypeId], references: [id])
  otaName         String   @map("ota_name")
  otaRoomName     String   @map("ota_room_name")
  confidenceScore Decimal? @map("confidence_score")

  @@map("ota_room_aliases")
}

model RoomRate {
  id           Int      @id @default(autoincrement())
  roomTypeId   String   @map("room_type_id")
  roomType     RoomType @relation(fields: [roomTypeId], references: [id])
  otaName      String   @map("ota_name")
  checkin      DateTime @map("checkin") // Date type mapping to DateTime in Prisma
  checkout     DateTime @map("checkout") // Date type
  basePrice    Decimal  @map("base_price")
  taxes        Decimal?
  currency     String
  refundable   Boolean?
  availability Int?
  bookingUrl   String   @map("booking_url")
  lastUpdated  DateTime @updatedAt @map("last_updated")

  @@index([roomTypeId, otaName])
  @@index([checkin, checkout])
  @@map("room_rates")
}

// ==========================================================
// LAYER 3: SEARCH & PERFORMANCE TABLES
// ==========================================================

model SearchSnapshot {
  searchHash   String   @id @map("search_hash")
  searchParams String   @map("search_params") // JSONB
  hotelIds     String   @map("hotel_ids") // UUID[], arrays not supported in SQLite, store as JSON string
  expiresAt    DateTime @map("expires_at")

  @@index([expiresAt])
  @@map("search_snapshots")
}

model Click {
  id            Int      @id @default(autoincrement())
  // Phase 2 fields (metasearch tracking)
  offerId       String?  @map("offer_id")
  partnerId     String?  @map("partner_id")
  userId        String?  @map("user_id")
  // Legacy fields (kept for backward compatibility)
  hotelId       String?  @map("hotel_id")
  ota           String?
  affiliateLink String?  @map("affiliate_link")
  ip            String?
  device        String?
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([offerId])
  @@index([partnerId])
  @@index([userId])
  @@map("clicks")
}

// ==========================================================
// AUTHENTICATION & USER MANAGEMENT
// ==========================================================

model Otp {
  id        Int      @id @default(autoincrement())
  identifier String  // email or mobile number
  otp       String   // 6-digit code
  type      String   // 'email' or 'mobile'
  expiresAt DateTime @map("expires_at")
  isUsed    Boolean  @default(false) @map("is_used")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([identifier])
  @@index([expiresAt])
  @@map("otps")
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  isUsed    Boolean  @default(false) @map("is_used")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

// ==========================================================
// DESTINATIONS
// ==========================================================

model Destination {
  id         Int     @id @default(autoincrement())
  city       String
  country    String
  region     String?
  latitude   Decimal?
  longitude  Decimal?
  population Int?
  isPopular  Boolean @default(false) @map("is_popular")

  @@index([city])
  @@index([country])
  @@index([isPopular])
  @@map("destinations")
}

// ==========================================================
// PARTNER MANAGEMENT
// ==========================================================

model Partner {
  id          String   @id  // 'booking', 'agoda', 'expedia', 'hotelscom'
  name        String   // 'Booking.com', 'Agoda', 'Expedia', 'Hotels.com'
  slug        String   @unique // URL-friendly: 'booking', 'agoda', etc.
  logo        String?  // Logo URL or icon name
  bookingType String   @map("booking_type") // 'redirect' or 'api'
  baseUrl     String?  @map("base_url") // For affiliate redirects
  isActive    Boolean  @default(true) @map("is_active")
  priority    Int      @default(0) // Display order
  createdAt   DateTime @default(now()) @map("created_at")
  
  offers      Offer[]
  
  @@map("partners")
}

// ==========================================================
// OFFER NORMALIZATION (Read-Only Price Snapshots)
// ==========================================================

model Offer {
  id           String   @id @default(uuid())
  hotelId      String   @map("hotel_id")
  partnerId    String   @map("partner_id")
  partner      Partner  @relation(fields: [partnerId], references: [id])
  roomName     String?  @map("room_name")
  price        Float
  currency     String
  refundable   Boolean
  cancellation String?
  deeplink     String
  fetchedAt    DateTime @map("fetched_at")
  createdAt    DateTime @default(now()) @map("created_at")
  
  @@index([hotelId])
  @@index([partnerId])
  @@index([fetchedAt])
  @@map("offers")
}
